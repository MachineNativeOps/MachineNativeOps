name: Gate - Root Specifications Validation
permissions:
  contents: read
true:
  pull_request:
    paths:
    - root.*.yaml
    - root.*.map
    - root.*.sh
    - root.specs.*.yaml
    - root.registry.*.yaml
  push:
    branches:
    - main
    paths:
    - root.*.yaml
    - root.*.map
    - root.*.sh
jobs:
  validate-root-specs:
    name: Validate Root Layer Specifications
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: üì¶ Install Dependencies
      run: 'python -m pip install --upgrade pip

        pip install pyyaml

        '
    - id: naming
      name: üîç Run Naming Validation
      run: "echo \"## \U0001F524 Naming Specification Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \n# Check file naming patterns\necho \"### File Naming Patterns\" >> $GITHUB_STEP_SUMMARY\n\
        \nINVALID_FILES=0\nfor file in root.*.yaml root.*.map root.*.sh; do\n  if\
        \ [ -f \"$file\" ]; then\n    # Check for uppercase letters\n    if echo \"\
        $file\" | grep -q '[A-Z]'; then\n      echo \"‚ùå File contains uppercase: $file\"\
        \ >> $GITHUB_STEP_SUMMARY\n      INVALID_FILES=$((INVALID_FILES + 1))\n  \
        \  fi\n    \n    # Check for spaces\n    if echo \"$file\" | grep -q ' ';\
        \ then\n      echo \"‚ùå File contains spaces: $file\" >> $GITHUB_STEP_SUMMARY\n\
        \      INVALID_FILES=$((INVALID_FILES + 1))\n    fi\n    \n    # Check for\
        \ .yml extension\n    if echo \"$file\" | grep -q '\\.yml$'; then\n      echo\
        \ \"‚ùå File uses .yml instead of .yaml: $file\" >> $GITHUB_STEP_SUMMARY\n \
        \     INVALID_FILES=$((INVALID_FILES + 1))\n    fi\n  fi\ndone\n\nif [ $INVALID_FILES\
        \ -eq 0 ]; then\n  echo \"‚úÖ All files pass naming validation\" >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"‚ùå Found $INVALID_FILES files with naming violations\" >> $GITHUB_STEP_SUMMARY\n\
        \  exit 1\nfi\n"
    - id: references
      name: üîó Run Reference Validation
      run: "echo \"## \U0001F517 Reference Specification Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \n# Check URN format\necho \"### URN Format Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \nif [ -f \"root.registry.urns.yaml\" ]; then\n  INVALID_URNS=$(grep -E \"\
        urn:\" root.registry.urns.yaml | grep -v \"^urn:machinenativeops:\" | wc -l)\n\
        \  \n  if [ $INVALID_URNS -eq 0 ]; then\n    echo \"‚úÖ All URNs use correct\
        \ namespace\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"‚ùå Found $INVALID_URNS\
        \ URNs with incorrect namespace\" >> $GITHUB_STEP_SUMMARY\n    exit 1\n  fi\n\
        else\n  echo \"‚ö†Ô∏è URN registry not found\" >> $GITHUB_STEP_SUMMARY\nfi\n"
    - id: mapping
      name: üó∫Ô∏è Run Mapping Validation
      run: "echo \"## \U0001F5FAÔ∏è Mapping Specification Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \n# Check module name consistency\necho \"### Module Name Consistency\" >>\
        \ $GITHUB_STEP_SUMMARY\n\nif [ -f \"root.registry.modules.yaml\" ]; then\n\
        \  echo \"‚úÖ Module registry found\" >> $GITHUB_STEP_SUMMARY\n  \n  # Extract\
        \ module names and check for duplicates\n  MODULE_COUNT=$(grep -E \"^\\s+-\
        \ id:\" root.registry.modules.yaml | wc -l)\n  UNIQUE_COUNT=$(grep -E \"^\\\
        s+- id:\" root.registry.modules.yaml | sort -u | wc -l)\n  \n  if [ $MODULE_COUNT\
        \ -eq $UNIQUE_COUNT ]; then\n    echo \"‚úÖ No duplicate module IDs found ($MODULE_COUNT\
        \ modules)\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"‚ùå Duplicate module\
        \ IDs detected\" >> $GITHUB_STEP_SUMMARY\n    exit 1\n  fi\nelse\n  echo \"\
        ‚ö†Ô∏è Module registry not found\" >> $GITHUB_STEP_SUMMARY\nfi\n"
    - id: logic
      name: üß† Run Logic Validation
      run: "echo \"## \U0001F9E0 Logic Specification Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \n# Check for basic YAML syntax\necho \"### YAML Syntax Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \nSYNTAX_ERRORS=0\nfor file in root.*.yaml; do\n  if [ -f \"$file\" ]; then\n\
        \    if ! python -c \"import yaml; yaml.safe_load(open('$file'))\" 2>/dev/null;\
        \ then\n      echo \"‚ùå YAML syntax error in: $file\" >> $GITHUB_STEP_SUMMARY\n\
        \      SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))\n    fi\n  fi\ndone\n\nif [ $SYNTAX_ERRORS\
        \ -eq 0 ]; then\n  echo \"‚úÖ All YAML files have valid syntax\" >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"‚ùå Found $SYNTAX_ERRORS files with syntax errors\" >> $GITHUB_STEP_SUMMARY\n\
        \  exit 1\nfi\n"
    - id: context
      name: üåê Run Context Validation
      run: "echo \"## \U0001F310 Context Specification Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \n# Check apiVersion consistency\necho \"### API Version Consistency\" >>\
        \ $GITHUB_STEP_SUMMARY\n\nAPI_VERSIONS=$(grep -h \"^apiVersion:\" root.*.yaml\
        \ 2>/dev/null | sort -u | wc -l)\n\nif [ $API_VERSIONS -le 2 ]; then\n  echo\
        \ \"‚úÖ API versions are consistent ($API_VERSIONS unique versions)\" >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"‚ö†Ô∏è Multiple API versions detected ($API_VERSIONS versions)\"\
        \ >> $GITHUB_STEP_SUMMARY\n  grep -h \"^apiVersion:\" root.*.yaml | sort -u\
        \ >> $GITHUB_STEP_SUMMARY\nfi\n"
    - id: python-validator
      name: üêç Run Python Validator
      run: "echo \"## \U0001F40D Python Validator Results\" >> $GITHUB_STEP_SUMMARY\n\
        \nchmod +x scripts/validation/validate-root-specs.py\n\nif python scripts/validation/validate-root-specs.py;\
        \ then\n  echo \"‚úÖ Python validation passed\" >> $GITHUB_STEP_SUMMARY\nelse\n\
        \  echo \"‚ùå Python validation failed\" >> $GITHUB_STEP_SUMMARY\n  cat root-specs-validation-report.md\
        \ >> $GITHUB_STEP_SUMMARY\n  exit 1\nfi\n"
    - if: always()
      name: üìä Generate Summary
      run: "echo \"## \U0001F4CA Validation Summary\" >> $GITHUB_STEP_SUMMARY\necho\
        \ \"\" >> $GITHUB_STEP_SUMMARY\n\nif [ \"${{ steps.naming.outcome }}\" ==\
        \ \"success\" ] && \\\n   [ \"${{ steps.references.outcome }}\" == \"success\"\
        \ ] && \\\n   [ \"${{ steps.mapping.outcome }}\" == \"success\" ] && \\\n\
        \   [ \"${{ steps.logic.outcome }}\" == \"success\" ] && \\\n   [ \"${{ steps.context.outcome\
        \ }}\" == \"success\" ] && \\\n   [ \"${{ steps.python-validator.outcome }}\"\
        \ == \"success\" ]; then\n  echo \"### ‚úÖ All Validations Passed!\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"The root layer specifications\
        \ are compliant with all defined rules.\" >> $GITHUB_STEP_SUMMARY\nelse\n\
        \  echo \"### ‚ùå Validation Failed\" >> $GITHUB_STEP_SUMMARY\n  echo \"\" >>\
        \ $GITHUB_STEP_SUMMARY\n  echo \"Please review the errors above and fix the\
        \ violations before merging.\" >> $GITHUB_STEP_SUMMARY\n  echo \"\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"#### Failed Checks:\" >> $GITHUB_STEP_SUMMARY\n  [ \"${{ steps.naming.outcome\
        \ }}\" != \"success\" ] && echo \"- ‚ùå Naming Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \  [ \"${{ steps.references.outcome }}\" != \"success\" ] && echo \"- ‚ùå Reference\
        \ Validation\" >> $GITHUB_STEP_SUMMARY\n  [ \"${{ steps.mapping.outcome }}\"\
        \ != \"success\" ] && echo \"- ‚ùå Mapping Validation\" >> $GITHUB_STEP_SUMMARY\n\
        \  [ \"${{ steps.logic.outcome }}\" != \"success\" ] && echo \"- ‚ùå Logic Validation\"\
        \ >> $GITHUB_STEP_SUMMARY\n  [ \"${{ steps.context.outcome }}\" != \"success\"\
        \ ] && echo \"- ‚ùå Context Validation\" >> $GITHUB_STEP_SUMMARY\n  [ \"${{\
        \ steps.python-validator.outcome }}\" != \"success\" ] && echo \"- ‚ùå Python\
        \ Validator\" >> $GITHUB_STEP_SUMMARY\nfi\n"
    - if: github.event_name == 'pull_request' && failure()
      name: üí¨ Comment on PR
      uses: actions/github-script@v7
      with:
        script: "const fs = require('fs');\nlet report = '## ‚ùå Root Specifications\
          \ Validation Failed\\n\\n';\n\nif (fs.existsSync('root-specs-validation-report.md'))\
          \ {\n  report += fs.readFileSync('root-specs-validation-report.md', 'utf8');\n\
          } else {\n  report += 'Please check the workflow logs for details.\\n';\n\
          }\n\nreport += '\\n---\\n';\nreport += '**Action Required:** Please fix\
          \ the violations and push the changes.\\n';\n\ngithub.rest.issues.createComment({\n\
          \  issue_number: context.issue.number,\n  owner: context.repo.owner,\n \
          \ repo: context.repo.repo,\n  body: report\n});\n"
    - if: always()
      name: üì§ Upload Validation Report
      uses: actions/upload-artifact@v4
      with:
        name: root-specs-validation-report
        path: root-specs-validation-report.md
        retention-days: 30
    - if: 'steps.naming.outcome != ''success'' ||

        steps.references.outcome != ''success'' ||

        steps.mapping.outcome != ''success'' ||

        steps.logic.outcome != ''success'' ||

        steps.context.outcome != ''success'' ||

        steps.python-validator.outcome != ''success''

        '
      name: ‚ùå Fail if Validation Failed
      run: 'echo "‚ùå Root specifications validation failed!"

        echo "Please review the errors and fix the violations."

        exit 1'
